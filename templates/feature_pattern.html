{% extends "layout.html" %}
{% block content %}

<style>
  .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }
  .panel{ border:1px solid #e5e7eb; border-radius:14px; padding:12px; background:#fff; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
  .muted{ color:#6b7280; font-size:12px; }
  .mono{ font-variant-numeric: tabular-nums; }
  .kpis{ display:flex; gap:10px; flex-wrap:wrap; }
  .kpi{ border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; min-width:160px; }
  .kpi .v{ font-size:18px; font-weight:700; }
  .bar-row{ display:grid; grid-template-columns: 44px 1fr 90px; gap:10px; align-items:center; padding:7px 0; border-bottom:1px dashed #e5e7eb; }
  .bar-row:last-child{ border-bottom:0; }
  .bar-bg{ background:#f3f4f6; border-radius:8px; height:10px; overflow:hidden; }
  .bar{ background:#111827; height:10px; border-radius:8px; width:0%; }
  .list{ margin:0; padding-left:18px; }
</style>

<div class="card">
  <h2 style="margin:0;">ğŸ§­ ê³µë¶€ íŒ¨í„´ ë¶„ì„ & í”¼ë“œë°±</h2>
  <div class="muted" style="margin-top:6px;">í”Œë˜ë„ˆì— ì €ì¥ëœ â€œì˜¤ëŠ˜ ê³µë¶€(í˜ì´ì§€)â€ ê¸°ë¡ìœ¼ë¡œ ìë™ ë¶„ì„í•©ë‹ˆë‹¤.</div>

  <div style="height:12px;"></div>

  <div class="panel">
    <div class="row">
      <div class="kpis">
        <div class="kpi">
          <div class="v mono" id="kActive">-</div>
          <div class="muted">ê³µë¶€í•œ ë‚  ìˆ˜</div>
        </div>
        <div class="kpi">
          <div class="v mono" id="kRecentAvg">-</div>
          <div class="muted">ìµœê·¼ 14ì¼ í‰ê· (ê³µë¶€í•œ ë‚  ê¸°ì¤€)</div>
        </div>
        <div class="kpi">
          <div class="v mono" id="kRange">-</div>
          <div class="muted">ë¶„ì„ ê¸°ê°„</div>
        </div>
      </div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <span class="muted">ê¸°ê°„</span>
        <select id="daysSel">
          <option value="30">ìµœê·¼ 30ì¼</option>
          <option value="60">ìµœê·¼ 60ì¼</option>
          <option value="90" selected>ìµœê·¼ 90ì¼</option>
          <option value="120">ìµœê·¼ 120ì¼</option>
          <option value="180">ìµœê·¼ 180ì¼</option>
        </select>
        <button class="btn" id="reloadBtn">ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>
  </div>

  <div style="height:12px;"></div>

  <div class="grid">
    <div class="panel">
      <div style="font-weight:700;">ìš”ì¼ë³„ í‰ê· (ê³µë¶€í•œ ë‚  ê¸°ì¤€)</div>
      <div class="muted">ê° ìš”ì¼ì— â€œê³µë¶€í•œ ë‚ â€ë§Œ í‰ê· ì— í¬í•¨ë©ë‹ˆë‹¤.</div>
      <div id="weekdayBars" style="margin-top:10px;"></div>
    </div>

    <div class="panel">
      <div style="font-weight:700;">ìµœê·¼ 8ì£¼ ì¶”ì„¸(ì£¼ê°„ ì´í•©)</div>
      <div class="muted">ì£¼ ë‹¨ìœ„ë¡œ í•©ì‚°í•œ ê³µë¶€ëŸ‰ì…ë‹ˆë‹¤.</div>
      <div id="weeklyBars" style="margin-top:10px;"></div>
    </div>
  </div>

  <div style="height:12px;"></div>

  <div class="panel">
    <div style="font-weight:700;">ìë™ í”¼ë“œë°±</div>
    <ul class="list" id="feedback" style="margin-top:10px;"></ul>
  </div>

  <div id="msg" class="muted" style="margin-top:12px;"></div>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  function barRow(label, valueText, ratio){
    const row = document.createElement("div");
    row.className = "bar-row";

    const left = document.createElement("div");
    left.textContent = label;

    const bg = document.createElement("div");
    bg.className = "bar-bg";

    const bar = document.createElement("div");
    bar.className = "bar";
    bar.style.width = Math.round(ratio * 100) + "%";
    bg.appendChild(bar);

    const right = document.createElement("div");
    right.className = "mono muted";
    right.style.textAlign = "right";
    right.textContent = valueText;

    row.appendChild(left);
    row.appendChild(bg);
    row.appendChild(right);
    return row;
  }

  async function load(){
    const days = $("daysSel").value;
    $("msg").textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

    const res = await fetch(`/api/pattern?days=${encodeURIComponent(days)}`);
    const data = await res.json();

    if(!res.ok || !data.ok){
      $("msg").textContent = "ì‹¤íŒ¨: " + (data.error || "unknown");
      return;
    }

    $("kActive").textContent = data.active_days + "ì¼";
    $("kRecentAvg").textContent = (data.recent14_avg_active || 0) + "p";
    $("kRange").textContent = `${data.start} ~ ${data.end}`;

    const w = data.weekday || [];
    const maxAvg = Math.max(0, ...w.map(x => x.avg_active || 0));
    const wrapW = $("weekdayBars");
    wrapW.innerHTML = "";
    w.forEach(x => {
      const ratio = maxAvg > 0 ? (x.avg_active / maxAvg) : 0;
      wrapW.appendChild(barRow(x.weekday, `${x.avg_active}p (ì´ ${x.total}p / ${x.days}ì¼)`, ratio));
    });

    const wk = data.weekly || [];
    const maxWk = Math.max(0, ...wk.map(x => x.total || 0));
    const wrapWK = $("weeklyBars");
    wrapWK.innerHTML = "";
    wk.forEach(x => {
      const ratio = maxWk > 0 ? (x.total / maxWk) : 0;
      const shortLabel = x.label.split("-W").pop();
      wrapWK.appendChild(barRow("W" + shortLabel, `${x.total}p`, ratio));
    });

    const fb = data.feedback || [];
    const ul = $("feedback");
    ul.innerHTML = "";
    fb.forEach(t => {
      const li = document.createElement("li");
      li.innerHTML = t;
      ul.appendChild(li);
    });

    $("msg").textContent = "ì™„ë£Œ";
  }

  $("reloadBtn").addEventListener("click", load);
  $("daysSel").addEventListener("change", load);
  load();
</script>

{% endblock %}
