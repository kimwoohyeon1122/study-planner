{% extends "layout.html" %}
{% block content %}

<style>
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .muted{ color:#6b7280; font-size:12px; }

  .grid{
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap:12px;
    margin-top:12px;
  }
  .thumb{
    border:1px solid #e5e7eb;
    border-radius:14px;
    padding:10px;
    background:#fff;
  }
  .thumb img{
    width:100%;
    border-radius:10px;
    cursor: zoom-in;
    display:block;
  }
  .thumb .meta{
    margin-top:8px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    flex-wrap:wrap;
  }

  /* modal */
  .modal{
    position:fixed;
    inset:0;
    background: rgba(0,0,0,0.55);
    display:none;
    align-items:center;
    justify-content:center;
    padding:16px;
    z-index: 9999;
  }
  .modal.open{ display:flex; }
  .modal-card{
    background:#fff;
    border-radius:16px;
    max-width: 980px;
    width:100%;
    max-height: 90vh;
    overflow:auto;
    padding:12px;
    border:1px solid #e5e7eb;
  }
  .modal-top{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
    margin-bottom:10px;
  }
  .modal-img{
    width:100%;
    border-radius:14px;
    display:block;
  }
</style>

<div class="card">
  <h2 style="margin:0;">ğŸ—“ï¸ ì‹œê°„í‘œ ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬</h2>
  <div class="muted" style="margin-top:6px;">ì‹œê°„í‘œ/ì°¸ê³ ìë£Œ ì´ë¯¸ì§€ë¥¼ ì—¬ëŸ¬ ì¥ ì—…ë¡œë“œí•˜ê³  í™•ëŒ€í•´ì„œ ë³¼ ìˆ˜ ìˆì–´ìš”.</div>

  <div style="height:12px;"></div>

  <div class="row">
    <input id="file" type="file" accept="image/*" style="max-width:320px;">
    <button class="btn" id="uploadBtn">ì—…ë¡œë“œ</button>
    <div id="msg" class="muted"></div>
  </div>

  {% if images and images|length > 0 %}
    <div class="grid">
      {% for img in images %}
        <div class="thumb">
          <img src="{{ img.url }}" alt="timetable" onclick="openModal('{{ img.url }}', '{{ img.uploaded_at }}')">
          <div class="meta">
            <span class="muted">{{ img.uploaded_at[:10] }}</span>
            <button class="btn-ghost" onclick="delImg({{ img.id }})">ì‚­ì œ</button>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="muted" style="margin-top:14px;">ì•„ì§ ì—…ë¡œë“œëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
  {% endif %}
</div>

<!-- Modal -->
<div class="modal" id="modal" onclick="closeModal(event)">
  <div class="modal-card" onclick="event.stopPropagation()">
    <div class="modal-top">
      <div class="muted" id="modalMeta"></div>
      <button class="btn-ghost" onclick="closeModal()">ë‹«ê¸°</button>
    </div>
    <img class="modal-img" id="modalImg" src="" alt="preview">
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  async function api(url, opts={}){
    const res = await fetch(url, opts);
    const data = await res.json().catch(()=> ({}));
    if(!res.ok) throw new Error(data.error || ("HTTP " + res.status));
    return data;
  }

  $("uploadBtn").addEventListener("click", async ()=>{
    const f = $("file").files[0];
    if(!f){ $("msg").textContent = "ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”."; return; }

    const fd = new FormData();
    fd.append("file", f);

    try{
      $("msg").textContent = "ì—…ë¡œë“œ ì¤‘...";
      await api("/api/upload/timetable", { method:"POST", body: fd });
      $("msg").textContent = "ì—…ë¡œë“œ ì™„ë£Œ! ìƒˆë¡œê³ ì¹¨ ì¤‘...";
      location.reload();
    }catch(e){
      $("msg").textContent = "ì—…ë¡œë“œ ì‹¤íŒ¨: " + e.message;
    }
  });

  async function delImg(id){
    if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
    try{
      await api(`/api/delete/timetable/${id}`, { method:"POST" });
      location.reload();
    }catch(e){
      alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message);
    }
  }
  window.delImg = delImg;

  function openModal(url, uploadedAt){
    $("modalImg").src = url;
    $("modalMeta").textContent = uploadedAt ? ("ì—…ë¡œë“œ: " + uploadedAt) : "";
    $("modal").classList.add("open");
  }
  function closeModal(){
    $("modal").classList.remove("open");
    $("modalImg").src = "";
  }
  window.openModal = openModal;
  window.closeModal = closeModal;

  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape") closeModal();
  });
</script>

{% endblock %}
