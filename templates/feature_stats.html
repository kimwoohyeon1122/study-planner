{% extends "layout.html" %}
{% block content %}

<style>
  .stats-grid{ display:grid; grid-template-columns: 1.2fr 0.8fr; gap:12px; }
  @media (max-width: 900px){ .stats-grid{ grid-template-columns: 1fr; } }

  .panel{ border:1px solid #e5e7eb; border-radius:14px; padding:12px; background:#fff; }
  .muted{ color:#6b7280; font-size:12px; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
  .kpi{ display:flex; gap:12px; flex-wrap:wrap; }
  .kpi .box{ border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; min-width:160px; }
  .kpi .v{ font-size:18px; font-weight:700; font-variant-numeric: tabular-nums; }

  .heatmap-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
  .heatmap{
    display:grid;
    grid-auto-flow: column;
    grid-auto-columns: 12px;
    grid-template-rows: repeat(7, 12px);
    gap:3px;
  }
  .cell{ width:12px; height:12px; border-radius:3px; background:#f3f4f6; border:1px solid rgba(0,0,0,0.03); }
  .legend{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
  .legend .sw{ width:12px; height:12px; border-radius:3px; border:1px solid rgba(0,0,0,0.03); }

  .bar-row{
    display:grid;
    grid-template-columns: 1fr 3fr auto;
    gap:10px;
    align-items:center;
    padding:8px 0;
    border-bottom:1px dashed #e5e7eb;
  }
  .bar-row:last-child{ border-bottom:0; }
  .bar{ height:10px; border-radius:6px; background:#111827; }
</style>

<div class="card">
  <h2 style="margin:0;">ğŸ“Š ê³µë¶€ ê¸°ë¡ & í†µê³„</h2>
  <div class="muted" style="margin-top:6px;">í”Œë˜ë„ˆì—ì„œ ì €ì¥í•œ â€œì˜¤ëŠ˜ ê³µë¶€â€ ê¸°ë¡ì„ ê¸°ë°˜ìœ¼ë¡œ ì§‘ê³„í•©ë‹ˆë‹¤.</div>

  <div style="height:12px;"></div>

  <div class="panel">
    <div class="row">
      <div class="kpi">
        <div class="box">
          <div class="v" id="kpiTotal">-</div>
          <div class="muted">ìµœê·¼ ê¸°ê°„ ì´ ê³µë¶€ëŸ‰(í˜ì´ì§€)</div>
        </div>
        <div class="box">
          <div class="v" id="kpiDays">-</div>
          <div class="muted">ê³µë¶€í•œ ë‚  ìˆ˜</div>
        </div>
        <div class="box">
          <div class="v" id="kpiAvg">-</div>
          <div class="muted">ê³µë¶€í•œ ë‚  ê¸°ì¤€ í‰ê· (í˜ì´ì§€)</div>
        </div>
      </div>

      <div class="row" style="justify-content:flex-end;">
        <span class="muted">ê¸°ê°„</span>
        <select id="daysSel">
          <option value="30">ìµœê·¼ 30ì¼</option>
          <option value="60">ìµœê·¼ 60ì¼</option>
          <option value="120" selected>ìµœê·¼ 120ì¼</option>
          <option value="180">ìµœê·¼ 180ì¼</option>
          <option value="365">ìµœê·¼ 365ì¼</option>
        </select>
        <button class="btn" id="reloadBtn">ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>
  </div>

  <div style="height:12px;"></div>

  <div class="stats-grid">
    <div class="panel">
      <div class="row">
        <div>
          <div style="font-weight:700;">íˆíŠ¸ë§µ(ë‚ ì§œë³„ ê³µë¶€ëŸ‰)</div>
          <div class="muted">0ì´ë©´ ì—°í•œìƒ‰, ë§ì´ í• ìˆ˜ë¡ ì§„í•´ì§‘ë‹ˆë‹¤.</div>
        </div>
        <div class="legend muted" id="legend"></div>
      </div>

      <div style="height:10px;"></div>
      <div class="heatmap-wrap"><div class="heatmap" id="heatmap"></div></div>
      <div class="muted" style="margin-top:10px;">ì…€ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ë‚ ì§œ/í˜ì´ì§€ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
    </div>

    <div class="panel">
      <div style="font-weight:700;">ê³¼ëª©ë³„ ëˆ„ì (í˜ì´ì§€)</div>
      <div class="muted">í”Œë˜ë„ˆì— ë“±ë¡ëœ ê³¼ëª© ê¸°ì¤€ì…ë‹ˆë‹¤.</div>
      <div style="height:10px;"></div>
      <div id="bars"></div>
    </div>
  </div>

  <div id="msg" class="muted" style="margin-top:12px;"></div>
</div>

<script>
  const $ = (id) => document.getElementById(id);
  function isoToDate(d){ return new Date(d + "T00:00:00"); }
  function fmt(iso){ return iso.replaceAll("-", "."); }
  function dayIndexMon0(dateObj){ const d = dateObj.getDay(); return (d + 6) % 7; }
  function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
  function shade(level){
    const colors = ["#f3f4f6", "#dbeafe", "#93c5fd", "#3b82f6", "#1d4ed8"];
    return colors[clamp(level,0,4)];
  }
  function buildLegend(){
    const el = $("legend"); el.innerHTML = "";
    el.append("ì ìŒ");
    for(let i=0;i<5;i++){
      const sw = document.createElement("span");
      sw.className = "sw";
      sw.style.background = shade(i);
      el.appendChild(sw);
    }
    el.append("ë§ìŒ");
  }
  function makeHeatmap(byDate, startIso, endIso){
    const map = new Map(); byDate.forEach(x => map.set(x.date, x.value));
    const start = isoToDate(startIso); const end = isoToDate(endIso);
    const startDow = dayIndexMon0(start); start.setDate(start.getDate() - startDow);

    const cells=[]; const values=[];
    for(let d = new Date(start); d <= end; d.setDate(d.getDate()+1)){
      const iso = d.toISOString().slice(0,10);
      const v = map.get(iso) ?? 0;
      cells.push({ iso, v }); values.push(v);
    }
    const maxV = Math.max(0, ...values);
    const p25 = maxV * 0.25, p50 = maxV * 0.50, p75 = maxV * 0.75;

    const hm = $("heatmap"); hm.innerHTML = "";
    cells.forEach(c => {
      let lvl = 0;
      if(c.v===0) lvl=0;
      else if(c.v<=p25) lvl=1;
      else if(c.v<=p50) lvl=2;
      else if(c.v<=p75) lvl=3;
      else lvl=4;

      const div = document.createElement("div");
      div.className = "cell";
      div.style.background = shade(lvl);
      div.title = `${fmt(c.iso)} Â· ${c.v}p`;
      hm.appendChild(div);
    });
  }
  function renderBars(bySubject){
    const wrap = $("bars"); wrap.innerHTML = "";
    const items = bySubject.filter(x => (x.total ?? 0) > 0);
    if(items.length === 0){
      wrap.innerHTML = `<div class="muted">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. í”Œë˜ë„ˆì—ì„œ â€œì €ì¥â€ì„ ëˆŒëŸ¬ ê¸°ë¡ì„ ìŒ“ì•„ë³´ì„¸ìš”.</div>`;
      return;
    }
    const maxT = Math.max(...items.map(x => x.total));
    items.slice(0, 12).forEach(x => {
      const row = document.createElement("div");
      row.className = "bar-row";

      const name = document.createElement("div");
      name.textContent = x.subject;

      const barWrap = document.createElement("div");
      barWrap.style.background = "#f3f4f6";
      barWrap.style.borderRadius = "6px";
      barWrap.style.height = "10px";
      barWrap.style.overflow = "hidden";

      const bar = document.createElement("div");
      bar.className = "bar";
      bar.style.width = `${Math.round((x.total / maxT) * 100)}%`;

      const val = document.createElement("div");
      val.className = "muted";
      val.style.fontVariantNumeric = "tabular-nums";
      val.textContent = `${x.total}p`;

      barWrap.appendChild(bar);
      row.appendChild(name);
      row.appendChild(barWrap);
      row.appendChild(val);
      wrap.appendChild(row);
    });
  }
  async function loadStats(){
    const days = $("daysSel").value;
    $("msg").textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
    const res = await fetch(`/api/stats?days=${encodeURIComponent(days)}`);
    const data = await res.json();
    if(!res.ok || !data.ok){
      $("msg").textContent = "ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + (data.error || "unknown");
      return;
    }
    $("msg").textContent = `${data.start} ~ ${data.end} ê¸°ì¤€`;
    $("kpiTotal").textContent = data.total_pages_done + "p";
    $("kpiDays").textContent = data.active_days + "ì¼";
    const avg = data.active_days > 0 ? (data.total_pages_done / data.active_days) : 0;
    $("kpiAvg").textContent = avg.toFixed(1) + "p";

    buildLegend();
    makeHeatmap(data.by_date, data.start, data.end);
    renderBars(data.by_subject);
  }
  $("reloadBtn").addEventListener("click", loadStats);
  $("daysSel").addEventListener("change", loadStats);
  loadStats();
</script>

{% endblock %}