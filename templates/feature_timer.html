{% extends "layout.html" %}
{% block content %}

<style>
  .timer-box{ max-width:560px; margin:0 auto; text-align:center; }
  .time{ font-size:54px; font-weight:900; margin:16px 0; }
  .row{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; align-items:center; }
  .hint{ font-size:13px; color:#6b7280; margin-top:8px; }
  .panel{ border:1px solid #e5e7eb; border-radius:16px; padding:14px; background:#fff; text-align:left; }
  .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  @media (max-width:560px){ .grid{ grid-template-columns:1fr; } }
  select,input{
    padding:12px; border-radius:12px; border:1px solid #e5e7eb;
    font-size:14px; width:100%; background:#fff;
  }
  .badge{
    display:inline-flex; padding:6px 10px; border-radius:999px;
    border:1px solid #e5e7eb; font-size:12px; background:#fff;
  }
  .btn-wide{ min-width:120px; }
</style>

<div class="card timer-box">
  <h2>⏱️ 집중 타이머 (누적 저장)</h2>
  <div class="hint">세션 종료 또는 즉시 저장 시 오늘 공부량에 <b>누적</b>됩니다.</div>

  <div class="panel" style="margin-top:14px;">
    <div class="grid">
      <div>
        <div class="hint">과목</div>
        <select id="planSelect"></select>
      </div>
      <div>
        <div class="hint">이번 세션 페이지</div>
        <input id="pagesDone" type="number" min="0" placeholder="예: 20">
      </div>
      <div>
        <div class="hint">타이머 시간(분)</div>
        <input id="minutes" type="number" min="1" max="300" value="25">
      </div>
    </div>

    <div class="row" style="justify-content:space-between; margin-top:8px;">
      <span class="badge" id="status">대기</span>
      <span class="badge" id="chosen"></span>
    </div>
  </div>

  <div class="time" id="time">25:00</div>

  <div class="row">
    <button class="btn btn-wide" onclick="start()">시작</button>
    <button class="btn-ghost btn-wide" onclick="pause()">중지 / 다시 시작</button>
    <button class="btn-ghost btn-wide" onclick="resetTimer()">리셋</button>
    <button class="btn btn-wide" onclick="saveNow()">즉시 저장</button>
  </div>

  <div class="hint" id="msg"></div>
</div>

<script>
const $ = (id)=>document.getElementById(id);
let timer=null, remain=25*60, running=false, paused=false;

function fmt(s){return String(Math.floor(s/60)).padStart(2,'0')+":"+String(s%60).padStart(2,'0');}
function setStatus(t){$("status").textContent=t;}

async function api(u,o){
  const r=await fetch(u,o||{}); const d=await r.json();
  if(!r.ok) throw new Error(d.error||"error"); return d;
}

async function loadPlans(){
  const d=await api("/api/plans");
  const sel=$("planSelect"); sel.innerHTML="";
  d.plans.forEach(p=>{
    const o=document.createElement("option");
    o.value=p.id; o.textContent=p.subject; sel.appendChild(o);
  });
  updateChosen();
}
function updateChosen(){
  const s=$("planSelect");
  $("chosen").textContent="선택: "+(s.options[s.selectedIndex]?.textContent||"");
}
$("planSelect").addEventListener("change",updateChosen);

function start(){
  if(running) return;
  if(paused){
    paused=false; running=true; setStatus("집중 중");
    timer=setInterval(tick,1000); return;
  }
  const m=Number($("minutes").value);
  remain=m*60; $("time").textContent=fmt(remain);
  running=true; setStatus("집중 중");
  timer=setInterval(tick,1000);
}
function pause(){
  if(running){
    clearInterval(timer); running=false; paused=true;
    setStatus("일시정지"); return;
  }
  if(paused){ start(); }
}
function resetTimer(){
  clearInterval(timer); running=false; paused=false;
  remain=Number($("minutes").value)*60;
  $("time").textContent=fmt(remain); setStatus("대기");
}

async function getTodayDone(planId){
  const d=await api("/api/today");
  const item=d.items.find(i=>i.plan_id==planId);
  return item ? item.done_today : 0;
}

async function saveAccumulated(){
  const planId=Number($("planSelect").value);
  const add=Number($("pagesDone").value||0);
  const current=await getTodayDone(planId);
  const total=current+add;
  await api("/api/log",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({plan_id:planId,pages_done:total})
  });
}

async function saveNow(){
  try{
    $("msg").textContent="누적 저장 중...";
    await saveAccumulated();
    $("msg").textContent="✅ 누적 저장 완료!";
  }catch(e){$("msg").textContent="저장 실패: "+e.message;}
}

async function tick(){
  remain--; $("time").textContent=fmt(remain);
  if(remain<=0){
    clearInterval(timer); running=false; paused=false;
    setStatus("종료");
    try{
      $("msg").textContent="종료! 누적 저장 중...";
      await saveAccumulated();
      $("msg").textContent="✅ 종료 후 누적 저장 완료!";
    }catch(e){$("msg").textContent="저장 실패: "+e.message;}
  }
}

$("time").textContent=fmt(remain);
loadPlans();
</script>

{% endblock %}


